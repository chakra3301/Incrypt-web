<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stego Encoder</title>
  <link rel="stylesheet" href="styles/common.css">
</head>
<body>
  <div class="container">
    <h1>Stego Encoder</h1>
    <form id="encodeForm" onsubmit="return false;">
      <label for="coverImage">Cover Image (optional):</label>
      <input type="file" id="coverImage" accept="image/*">
      <label for="dataFile">Data File to Encode:</label>
      <input type="file" id="dataFile" required>
      <label for="bits">Bits per Channel:</label>
      <select id="bits">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4" selected>4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
      </select>
      <button id="encodeBtn">Encode</button>
    </form>
    <div id="progressContainer" style="display:none;">
      <div class="progress-bar"><div class="progress" id="progressBar"></div></div>
      <span id="progressText"></span>
    </div>
    <a id="downloadLink" style="display:none; margin-top:2rem;"></a>
    <div class="action-buttons">
      <button class="action-button" onclick="encode()">Encode</button>
      <button class="action-button" onclick="decode()">Decode</button>
      <a href="http://localhost:3000" target="_blank" class="action-button" style="text-decoration: none; display: inline-block;">
        Advanced Encoder/Decoder
      </a>
    </div>
  </div>
  <script>
    // Inline worker code for encoding (minified for brevity, see stego-worker.ts for full logic)
    const workerScript = `self.onmessage=function(e){const t=e.data;/* ...worker logic here... */}`;
    const encoderWorkerBlob = new Blob([workerScript], { type: 'application/javascript' });
    const encoderWorkerUrl = URL.createObjectURL(encoderWorkerBlob);

    const encodeForm = document.getElementById('encodeForm');
    const coverImageInput = document.getElementById('coverImage');
    const dataFileInput = document.getElementById('dataFile');
    const bitsInput = document.getElementById('bits');
    const encodeBtn = document.getElementById('encodeBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const downloadLink = document.getElementById('downloadLink');

    encodeBtn.onclick = async function() {
      const dataFile = dataFileInput.files[0];
      if (!dataFile) return alert('Please select a data file.');
      const coverImage = coverImageInput.files[0];
      const bits = parseInt(bitsInput.value, 10);
      encodeBtn.disabled = true;
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressText.textContent = 'Starting...';
      downloadLink.style.display = 'none';

      // Create worker
      const worker = new Worker(encoderWorkerUrl);
      worker.onmessage = function(e) {
        const data = e.data;
        if (data.pct !== undefined) {
          progressBar.style.width = (data.pct * 100) + '%';
        }
        if (data.status) {
          progressText.textContent = data.status;
        }
        if (data.done) {
          progressBar.style.width = '100%';
          progressText.textContent = 'Done!';
          const url = URL.createObjectURL(data.png);
          downloadLink.href = url;
          downloadLink.download = 'encoded.png';
          downloadLink.textContent = 'Download Encoded PNG';
          downloadLink.style.display = 'block';
          encodeBtn.disabled = false;
        }
        if (data.error) {
          alert(data.error);
          encodeBtn.disabled = false;
          progressContainer.style.display = 'none';
        }
      };
      // Prepare file URLs
      const dataURL = URL.createObjectURL(dataFile);
      let imageURL = undefined;
      if (coverImage) imageURL = URL.createObjectURL(coverImage);
      worker.postMessage({
        type: 'encode',
        dataURL,
        imageURL,
        bits,
        autoExpand: true,
        maxCanvas: 25000
      });
    };
  </script>
</body>
</html>